<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://balkan.app/js/FamilyTree.js"></script>
    <title>Sơ Đồ Phả Hệ Dòng Họ Lã Hữu</title>
    <style>
    /*CSS*/
    html, body{
      width: 100%;
      height: 100%;
      padding: 0;
      margin:0;
      overflow: hidden;
      font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
      background-color: #ffffff;
    }
    #tree{
      width:100%;
      height:100%;
    }

    /* --- CSS HIỆU ỨNG HIGHLIGHT --- */
    /* Định nghĩa animation nhấp nháy đường viền */
    @keyframes highlight-pulse {
        0% { stroke: #FF0000; stroke-width: 4px; stroke-opacity: 1; }
        50% { stroke: #FF0000; stroke-width: 8px; stroke-opacity: 0.5; }
        100% { stroke: #FF0000; stroke-width: 4px; stroke-opacity: 1; }
    }

    /* Class này sẽ được thêm vào Node khi tìm kiếm/click */
    .node-highlight rect {
        stroke: #FF0000 !important; /* Màu đỏ */
        animation: highlight-pulse 1.5s infinite; /* Chạy hiệu ứng liên tục */
    }

    /* --- CSS CHO NODE GỐC (ROOT NODE) --- */
    /* Class này được tự động sinh ra khi node có tags: ['root_node'] */
    .node-root_node rect {
        /* Màu viền vàng nổi bật */
        stroke: #FFD700 !important; 
        /* Viền dày hơn các node thường */
        stroke-width: 6px !important;
        /* Thêm hiệu ứng đổ bóng vàng cho rực rỡ hơn */
        filter: drop-shadow(0 0 5px #FFD700);
    }
    </style>
</head>
<body>
    <div id="tree"></div>
    
    <script src="data.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // --- 1. CẤU HÌNH TEMPLATE ---
            FamilyTree.SEARCH_PLACEHOLDER = "Tìm kiếm thành viên...";

            FamilyTree.templates.base.defs = 
                `<g transform="matrix(1,0,0,1,0,0)" id="dot"><circle class="ba-fill" cx="0" cy="0" r="5" stroke="#aeaeae" stroke-width="1"></circle></g>
                <g id="base_node_menu" style="cursor:pointer;">
                    <rect x="0" y="0" fill="transparent" width="22" height="22"></rect>
                    <circle cx="4" cy="11" r="2" fill="#fff"></circle>
                    <circle cx="11" cy="11" r="2" fill="#fff"></circle>
                    <circle cx="18" cy="11" r="2" fill="#fff"></circle>
                </g>`;

            FamilyTree.templates.treeLaHuu = Object.assign({}, FamilyTree.templates.tommy);
            FamilyTree.templates.treeLaHuu.size = [120, 180];
            
            FamilyTree.templates.treeLaHuu_male = Object.assign({}, FamilyTree.templates.treeLaHuu);
            FamilyTree.templates.treeLaHuu_female = Object.assign({}, FamilyTree.templates.treeLaHuu);

            // Cấu hình khung thẻ
            FamilyTree.templates.treeLaHuu_male.node = 
                `<rect x="0" y="0" height="{h}" width="{w}" stroke-width="1" fill="#039BE5" stroke="#aeaeae" rx="10" ry="10"></rect>`;
            FamilyTree.templates.treeLaHuu_female.node = 
                `<rect x="0" y="0" height="{h}" width="{w}" stroke-width="1" fill="#CDB38B" stroke="#aeaeae" rx="10" ry="10"></rect>`;

            // field_0: TÊN (Đẩy lên y=65 để nhường chỗ cho field_1)
            FamilyTree.templates.treeLaHuu.field_0 = 
            FamilyTree.templates.treeLaHuu_male.field_0 =
            FamilyTree.templates.treeLaHuu_female.field_0 =
                `<text data-width="100" data-text-overflow="multiline" style="font-size: 18px; font-weight: bold;" fill="#fff" x="60" y="65" text-anchor="middle">{val}</text>`;

            // field_1: TITLE (Chức vụ hoặc Đời) - Hiển thị ngay dưới field_0
            FamilyTree.templates.treeLaHuu.field_1 = 
            FamilyTree.templates.treeLaHuu_male.field_1 =
            FamilyTree.templates.treeLaHuu_female.field_1 =
                `<text data-width="100" data-text-overflow="multiline" style="font-size: 13px;" fill="#f0f0f0" x="60" y="110" text-anchor="middle">{val}</text>`;

            // Menu nút bấm
            FamilyTree.templates.treeLaHuu.nodeTreeMenuButton = 
            FamilyTree.templates.treeLaHuu_male.nodeTreeMenuButton = 
            FamilyTree.templates.treeLaHuu_female.nodeTreeMenuButton = "";
                // `<use ${'data-ctrl-n-t-menu-id'}="{id}" x="90" y="5" xlink:href="#base_tree_menu" />`;

            FamilyTree.templates.treeLaHuu.nodeMenuButton =
            FamilyTree.templates.treeLaHuu_male.nodeMenuButton =
            FamilyTree.templates.treeLaHuu_female.nodeMenuButton =
                `<use ${FamilyTree.attr.control_node_menu_id}="{id}" x="5" y="5" xlink:href="#base_node_menu" />`;

            // Xóa ảnh
            FamilyTree.templates.treeLaHuu.img_0 = "";
            FamilyTree.templates.treeLaHuu_male.img_0 = "";
            FamilyTree.templates.treeLaHuu_female.img_0 = "";

            FamilyTree.templates.root_node = Object.assign({}, FamilyTree.templates.treeLaHuu);
            FamilyTree.templates.root_node.node = 
                `<rect x="0" y="0" height="{h}" width="{w}" stroke-width="3" fill="#FF0000" stroke="#FFD700" rx="10" ry="10"></rect>`;

            FamilyTree.templates.mark_node = Object.assign({}, FamilyTree.templates.treeLaHuu);
            FamilyTree.templates.mark_node.node = 
                `<rect x="0" y="0" height="{h}" width="{w}" stroke-width="3" fill="#66CD00" stroke="#0000FF" rx="10" ry="10"></rect>`;


            // --- 2. XỬ LÝ DỮ LIỆU ---
            
            let nodes = [];
            let autoId = 1;
            let sourceData = defaultData;

            const stored = localStorage.getItem('genealogyData');
            if (stored) {
                try { sourceData = JSON.parse(stored); } catch (e) {}
            }

            function detectGender(member) {
                if (member.gioi_tinh) return member.gioi_tinh === 'Nữ' ? 'female' : 'male';
                if (member.ho_ten && member.ho_ten.toUpperCase().includes(" THỊ ")) return 'female';
                return 'male';
            }

            function getChildren(member) {
                return member.children || member.con_cai || [];
            }

            function parseMember(member, fatherId = null, motherId = null) {
                if (!member) return;

                let currentId = autoId++;
                let gender = detectGender(member);
                
                // Lấy thông tin thế hệ (hỗ trợ nhiều key khác nhau)
                let gen = member.gen || member.doi || member.generation || "";
                
                // Tạo Title theo yêu cầu: Chức vụ HOẶC "Đời thứ X"
                let title = member.chuc_vu || (gen ? `Thế hệ F${gen}` : "");

                let isRootNode = (fatherId === null && motherId === null);

                let personNode = {
                    id: currentId,
                    mid: motherId,
                    fid: fatherId,
                    name: member.ho_ten,
                    title: title, // Binding vào field_1
                    gender: gender,
                    // Gán thẻ 'root_node' nếu là gốc để CSS nhận biết
                    tags: isRootNode ? ['root_node'] : (member.mark ? ['mark_node'] : []),
                };
                
                let partnerIds = [];
                let spouses = [];

                if (member.vo) {
                    let list = Array.isArray(member.vo) ? member.vo : [member.vo];
                    list.forEach(v => spouses.push({type: 'vo', data: v}));
                }
                if (member.chong) {
                    let list = Array.isArray(member.chong) ? member.chong : [member.chong];
                    list.forEach(c => spouses.push({type: 'chong', data: c}));
                }

                spouses.forEach(spouse => {
                    let sId = autoId++;
                    let sName = (typeof spouse.data === 'object') ? spouse.data.ho_ten : spouse.data;
                    let sGender = (spouse.type === 'vo') ? 'female' : 'male';
                    
                    // Title cho vợ/chồng
                    let sTitle = (typeof spouse.data === 'object' && spouse.data.chuc_vu) 
                        ? spouse.data.chuc_vu 
                        : (spouse.type === 'vo' ? 'Vợ' : 'Chồng');

                    let spouseNode = {
                        id: sId,
                        pids: [currentId],
                        name: sName,
                        title: sTitle,
                        gender: sGender,
                        // Nếu chồng/vợ chính là gốc, thì người phối ngẫu cũng được tính là gốc
                        tags: isRootNode ? ['root_node'] : []
                    };
                    nodes.push(spouseNode);
                    partnerIds.push(sId);
                });

                if (partnerIds.length > 0) personNode.pids = partnerIds;
                nodes.push(personNode);

                let childrenList = getChildren(member);
                if (childrenList && childrenList.length > 0) {
                    let childFid = (personNode.gender === 'male') ? currentId : null;
                    let childMid = (personNode.gender === 'female') ? currentId : null;

                    if (partnerIds.length === 1) {
                        if (personNode.gender === 'male') childMid = partnerIds[0];
                        else childFid = partnerIds[0];
                    }

                    childrenList.forEach(child => {
                        parseMember(child, childFid, childMid);
                    });
                }
            }

            if (sourceData) {
                let rootData = sourceData.genealogy || sourceData.cay_pha_he;
                if (rootData && Array.isArray(rootData)) {
                    rootData.forEach(root => parseMember(root));
                }
            }

            // --- 3. KHỞI TẠO BIỂU ĐỒ ---
            let family = new FamilyTree(document.getElementById("tree"), {
                mode: 'light',
                nodeTreeMenu: true,
                scaleInitial: FamilyTree.match.boundary,
                template: 'treeLaHuu',
                menu: {
                    pdf: { text: "Export PDF" },
                    json: { text: "Export JSON" }
                },
                // nodeMenu: {
                //     details: { text: "Chi tiết" },
                //     edit: { text: "Sửa" }
                // },
                mouseScrool: FamilyTree.action.zoom,
                nodeBinding: {
                    field_0: "name",  // Tên
                    field_1: "title"  // Chức vụ / Đời
                },
                tags: {
                    root_node: {
                        template: 'root_node'
                    },
                    mark_node: {
                        template: 'mark_node'
                    }
                }
            });

            // --- 4. XỬ LÝ SỰ KIỆN HIGHLIGHT ---
            // Khi click hoặc tìm kiếm thành công (click vào kết quả tìm kiếm), hàm này sẽ chạy
            family.on('click', function (sender, args) {
                // Xóa highlight cũ
                const oldHighlights = document.querySelectorAll('.node-highlight');
                oldHighlights.forEach(el => el.classList.remove('node-highlight'));

                // Thêm highlight mới cho node vừa chọn
                // FamilyTreeJS tạo thẻ <g> có attribute data-n-id="{id}" cho mỗi node
                const nodeEl = document.querySelector(`[data-n-id="${args.node.id}"]`);
                if (nodeEl) {
                    nodeEl.classList.add('node-highlight');
                }
            });

            family.load(nodes);
        });
    </script>
</body>
</html>