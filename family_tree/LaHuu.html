<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Ph·∫£ H·ªá D√≤ng H·ªç L√£ H·ªØu</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f9; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* HEADER */
        header { text-align: center; border-bottom: 2px solid #ffd700; padding-bottom: 20px; margin-bottom: 20px; }
        h1 { color: #d32f2f; margin: 0; text-transform: uppercase; }
        .subtitle { color: #666; font-style: italic; margin-top: 5px; }
        
        /* TOOLBAR (Load/Save JSON) */
        .toolbar { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .toolbar input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-tool { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .btn-load { background: #0288d1; }
        .btn-save { background: #2e7d32; }
        .btn-tool:hover { opacity: 0.9; }

        /* SEARCH BOX */
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-box input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; outline: none; }
        .search-box input:focus { border-color: #d32f2f; }
        .btn-search { padding: 12px 25px; background: #d32f2f; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-search:hover { background: #b71c1c; }

        /* RESULT LIST */
        .result-list { list-style: none; padding: 0; }
        .member-card { background: #fff8e1; border: 1px solid #ffe0b2; padding: 20px; margin-bottom: 15px; border-radius: 8px; position: relative; }
        .member-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #d7ccc8; padding-bottom: 10px; margin-bottom: 10px; }
        .member-name { font-size: 1.3em; font-weight: bold; color: #d32f2f; }
        .member-gen { background: #5d4037; color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.85em; }
        .member-info { margin: 8px 0; font-size: 1em; }
        .label { font-weight: bold; color: #555; display: inline-block; min-width: 100px; }
        
        /* EDIT ACTIONS */
        .actions { margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .btn-action { padding: 5px 10px; border: 1px solid #aaa; background: white; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .btn-action:hover { background: #eee; }
        .btn-add-spouse { color: #e91e63; border-color: #e91e63; }
        .btn-add-child { color: #009688; border-color: #009688; }
        
        /* CHILDREN LIST */
        .children-list { background: white; padding: 10px; border-radius: 5px; border: 1px solid #eee; margin-top: 10px; }
        .children-label { font-weight: bold; color: #d32f2f; display: block; margin-bottom: 5px; }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 20px; width: 400px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-header h3 { margin: 0; color: #333; }
        .close-modal { font-size: 24px; cursor: pointer; color: #999; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .modal-footer { text-align: right; margin-top: 20px; }
        .btn-confirm { background: #d32f2f; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; }

        .no-result { text-align: center; color: #777; font-style: italic; }



        .header-title-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }


        .btn-history {
            background-color: #00796b;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .btn-history:hover {
            background-color: #004d40;
        }

        .btn-history:before {
            content: "üìú"; 
        }


        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); 
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            border-radius: 10px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
            animation: slideIn 0.3s;
        }

        .modal-header {
            padding: 15px 20px;
            background-color: #d32f2f;
            color: white;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.2em;
        }

        .close {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #ffd700;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px 30px;
            line-height: 1.8;
            font-size: 16px;
            text-align: justify;
            max-height: 70vh;
            overflow-y: auto;
        }

        .history-text p {
            margin-bottom: 15px;
            text-indent: 20px;
        }
        
        .highlight-text {
            color: #d32f2f;
            font-weight: bold;
        }

        .modal-footer {
            padding: 10px 20px;
            background-color: #eee;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            text-align: right;
            font-style: italic;
            font-size: 0.9em;
            color: #666;
        }

        @keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        @keyframes slideIn { from {transform: translateY(-50px); opacity: 0} to {transform: translateY(0); opacity: 1} }
        
        @media screen and (max-width: 600px) {
            .modal-content { width: 95%; margin: 10% auto; }
            .header-title-row { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-title-row">
            <h1>Tra C·ª©u Ph·∫£ H·ªá L√£ H·ªØu</h1>
            <button class="btn-history" onclick="openModal()"></button>
        </div>
        <p class="subtitle" id="oldAddress">Th√¥n Y√™n Li√™u Th∆∞·ª£ng, x√£ Kh√°nh Th·ªãnh, huy·ªán Y√™n M√¥, t·ªânh Ninh B√¨nh</p>
        <p class="note-address" id="newAddress"></p>
    </header>

    <div class="toolbar">
        <label><b>Ngu·ªìn d·ªØ li·ªáu:</b></label>
        <input type="text" id="jsonUrl" placeholder="D√°n link JSON v√†o ƒë√¢y (ƒë·ªÉ tr·ªëng s·∫Ω d√πng d·ªØ li·ªáu g·ªëc)">
        <button class="btn-tool btn-load" onclick="loadDataFromUrl()">Import JSON</button>
        <button class="btn-tool btn-save" onclick="downloadJSON()">Backup JSON</button>
    </div>

    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Nh·∫≠p t√™n th√†nh vi√™n c·∫ßn t√¨m...">
        <button class="btn-search" onclick="searchMember()">T√¨m ki·∫øm</button>
    </div>

    <div id="resultsArea">
        <p class="no-result">Nh·∫≠p t√™n v√†o √¥ t√¨m ki·∫øm ƒë·ªÉ b·∫Øt ƒë·∫ßu tra c·ª©u v√† ch·ªânh s·ª≠a.</p>
    </div>
</div>

<div id="spouseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Th√™m V·ª£/Ch·ªìng</h3>
            <span class="close-modal" onclick="closeModal('spouseModal')">&times;</span>
        </div>
        <div class="form-group">
            <label>H·ªç t√™n:</label>
            <input type="text" id="spouseName">
        </div>
        <div class="form-group">
            <label>Vai tr√≤:</label>
            <select id="spouseRole">
                <option value="vo">V·ª£</option>
                <option value="chong">Ch·ªìng</option>
            </select>
        </div>
        <div class="modal-footer">
            <button class="btn-confirm" onclick="confirmAddSpouse()">L∆∞u l·∫°i</button>
        </div>
    </div>
</div>

<div id="childModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Th√™m Con</h3>
            <span class="close-modal" onclick="closeModal('childModal')">&times;</span>
        </div>
        <div class="form-group">
            <label>H·ªç t√™n con:</label>
            <input type="text" id="childName">
        </div>
        <div class="form-group">
            <label>Gi·ªõi t√≠nh:</label>
            <select id="childGender">
                <option value="Nam">Nam</option>
                <option value="N·ªØ">N·ªØ</option>
            </select>
        </div>
        <div class="form-group">
            <label>Ghi ch√∫ (n·∫øu c√≥):</label>
            <input type="text" id="childNote">
        </div>
        <div class="modal-footer">
            <button class="btn-confirm" onclick="confirmAddChild()">L∆∞u l·∫°i</button>
        </div>
    </div>
</div>



<div id="historyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>TR√çCH ƒêO·∫†N GIA PH·∫¢ H·ªå L√É H·ªÆU</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="history-text">
                <p>Ngu·ªìn g·ªëc h·ªç L√£ H·ªØu qua t√¨m hi·ªÉu vƒÉn bia, truy·ªÅn kh·∫©u v√† gi·∫•y t·ªù Gia Ph·∫£ ƒë·ªÉ l·∫°i th√¨ kho·∫£ng cu·ªëi th·∫ø k·ª∑ 16 th·ªßy t·ªï h·ªç L√£ ƒë√£ c√≥ m·∫∑t tr√™n ƒë·∫•t Y√™n Li√™u, ƒë·∫øn ƒë·ªùi th·ª© 3 kh√¥ng ghi ƒë∆∞·ª£c h·∫øt. Theo gia ph·∫£ ƒë·ªÉ l·∫°i vi·ªÖn t·ªï h·ªç L√£ l√† c·ª• <span class="highlight-text">L√£ H·ªØu Gi·ªØa</span>, sinh h·∫° ƒë∆∞·ª£c c·ª• L√£ H·ªØu ƒêi·ªÅn. C·ª• L√£ H·ªØu ƒêi·ªÅn sinh ƒë∆∞·ª£c 2 nam (L√£ H·ªØu L√Ω, L√£ H·ªØu Khu) v√† 2 n·ªØ.</p>
                <p>Sinh th·ªùi c·ª• <span class="highlight-text">L√£ H·ªØu L√Ω</span> ƒë∆∞·ª£c Tri·ªÅu ƒë√¨nh nh√† L√™ th·ª• phong ch·ª©c Th·ªß H·ª£p, c·ª• l·∫•y b√† L√£ Th·ªã T·∫°i, con c·ª• L√£ H·ªØu Kim l√†m Tri ph·ªß ƒê·ªìng Ti√™u. √îng b√† sinh h·∫° ƒë∆∞·ª£c 9 ng∆∞·ªùi con, kinh t·∫ø gia ƒë√¨nh kh√° gi·∫£.</p>
                <p>NƒÉm M·∫≠u Tu·∫•t 1778 m·∫•t m√πa, l·∫°i chi·∫øn tranh, d√¢n t√¨nh thi·∫øu th·ªën ƒë√≥i r√©t, m·ªôt s·ªë ng∆∞·ªùi ch·∫øt. Gia ƒë√¨nh ƒë√£ d√†nh d·ª•m c·ª©u ƒë√≥i b√† con trong th√¥n ·∫•p, c√πng l√∫c ƒë√≥ gia ƒë√¨nh th∆∞·ªùng mua v√°n gi√∫p ƒë·ª° nh·ªØng ng∆∞·ªùi ch·∫øt kh√¥ng n∆°i n∆∞∆°ng t·ª±a.</p>
                <p>NƒÉm 1788 Vua Quang Trung t·∫•n c√¥ng ra B·∫Øc, l√∫c ƒë√≥ m·ªôt s·ªë ng∆∞·ªùi ch·ªãu ∆°n vua L√™ t√¨m c√°ch ch·ªëng l·∫°i. M·ªôt ng∆∞·ªùi t√™n S√°u ng∆∞·ªùi H√† D∆∞∆°ng, H√† Trung, Thanh H√≥a c√≥ √¢m m∆∞u ch·ªëng l·∫°i nh√† T√¢y S∆°n v√† l·∫©n tr·ªën ·ªü nh√† b·ªë v·ª£ qu√™ ngo·∫°i l√†ng Y√™n Li√™u ƒë·ªÉ ·∫©n d·∫≠t. Sau n√†y qu√¢n T√¢y S∆°n b·∫Øt ƒë∆∞·ª£c ·ªü s√¥ng V√¢n S√†ng, ƒë·ªìng th·ªùi v·ªÅ l√†ng b·∫Øt th√™m 3 ng∆∞·ªùi n·ªØa ƒë·ªÉ tra x√©t.</p>
                <p>C·ª• L√£ H·ªØu L√Ω nguy√™n Th·ªß H·ª£p, √¥ng D∆∞∆°ng Th·ªã Ho√†n l√†m tri s·ª±, √¥ng L√£ ƒê√¨nh Th·ª©c l√† l√£o th√†nh, b·ªã b·∫Øt ƒëem ƒëi tra kh·∫£o. Sau m·ªôt th·ªùi gian hai √¥ng ƒë∆∞·ª£c tha v·ªÅ r·ªìi m·∫•t. Ri√™ng c·ª• L√£ H·ªØu L√Ω c√≤n t·∫°i giam ƒë·∫øn ng√†y 04/12/1789 (√¢m l·ªãch). C·ª• b·ªã ƒë√°nh ƒë·∫≠p v√† hy sinh trong nh√† t√π. D√¢n l√†ng bi·∫øt ƒë∆∞·ª£c tin n√†y h·ªçp l·∫°i ƒë·ªÉ nh·ªõ ∆°n 3 c·ª• ch·ªãu ƒë√≤n oan v√† ƒë·ªÅ ngh·ªã c·∫•p tr√™n minh x√©t.</p>
                <p>C·ª• L√™ ƒê√¨nh Th·ª©c v√† c·ª• D∆∞∆°ng Th·ªã Ho√†n v√¨ d√¢n m√† ch·ªãu ƒë√≤n tan ƒë∆∞·ª£c d√¢n l√†ng tr√¥ng coi v·ª£ con m·ªôt ƒë·ªùi. C√≤n c·ª• L√£ H·ªØu L√Ω ƒë∆∞·ª£c d√¢n l√†ng, c·∫•p tr√™n x√©t l√† ng∆∞·ªùi c√≥ ƒë·ª©c, c√≥ nh√¢n, gi√∫p ng∆∞·ªùi ƒë√≥i kh·ªï, ch·ªãu ƒë√≤n oan l√∫c c·∫ßn chi·∫øn s·ª±. C·ª• ƒë∆∞·ª£c phong hai ch·ªØ: <span class="highlight-text">"H·∫≠u Th·∫ßn"</span>.</p>
                <p>H·∫≠u Th·∫ßn l√†ng s·ªëng T·∫øt ch·∫øt Gi·ªó.</p>
                <p style="text-align: center; font-weight: bold; font-style: italic;">"Tr·∫£i qua h∆°n 300 nƒÉm, T·ªï ti√™n d√≤ng h·ªç L√£ H·ªØu tr·ªìng ƒë·ª©c tr·ªìng nh√¢n, ƒë·ªùi n√†y qua ƒë·ªùi kh√°c u·ªëng n∆∞·ªõc nh·ªõ ngu·ªìn!"</p>
            </div>
        </div>
        <div class="modal-footer">
            Ng∆∞·ªùi l·∫≠p ph·∫£ ƒë·ªì: √îng L√£ Ng·ªçc Anh (L√£ H·ªØu Bang) F11 - Th√°ng 10/2017
        </div>
    </div>
</div>

<script>
    // --- 1. D·ªÆ LI·ªÜU G·ªêC (Backup) ---
    const defaultData = {
    "thong_tin_chung":
    {
        "tieu_de": "PH·∫¢ ƒê·ªí D√íNG H·ªå L√É H·ªÆU",
        "dia_chi": "Th√¥n Y√™n Li√™u Th∆∞·ª£ng, x√£ Kh√°nh Th·ªãnh, huy·ªán Y√™n M√¥, t·ªânh Ninh B√¨nh",
        "nguon_goc": "T·ªï h·ªç L√£ ƒë√£ c√≥ m·∫∑t t·∫°i ƒë·∫•t Y√™n Li√™u ƒë·∫øn nay ƒë·ªùi th·ª© 3 kh√¥ng ghi ch√©p h·∫øt ƒë∆∞·ª£c. Theo gia ph·∫£ ƒë·ªÉ l·∫°i, t·ªï h·ªç L√£ l√† c·ª• L√£ H·ªØu Gi·ªØa.",
        "thuy_to": "L√É H·ªÆU GI·ªÆA"
    },
    "cay_pha_he":
    [
        {
            "doi": 1,
            "ho_ten": "L√É H·ªÆU GI·ªÆA",
            "ten_khac": "L√É H·ªÆU TR·ªåNG",
            "con_cai":
            [
                {
                    "doi": 2,
                    "ho_ten": "L√É H·ªÆU ƒêI·ªÄN",
                    "vo": "D∆Ø∆†NG TH·ªä C·ª¶A",
                    "con_cai":
                    [
                        {
                            "doi": 3,
                            "ho_ten": "L√É H·ªÆU L√ù",
                            "chuc_vu": "Th·ªß H·ª£p - H·∫≠u Th·∫ßn",
                            "vo": "L√É TH·ªä T·∫†I"
                        },
                        {
                            "doi": 3,
                            "ho_ten": "L√É H·ªÆU KHU",
                            "con_cai":
                            [
                                {
                                    "doi": 4,
                                    "ho_ten": "L√É H·ªÆU V∆Ø·ª¢NG",
                                    "vo":
                                    [
                                        "L√ä TH·ªä PH√öC",
                                        "V≈® TH·ªä ƒê√ÄO"
                                    ],
                                    "con_cai":
                                    [
                                        {
                                            "doi": 5,
                                            "ho_ten": "L√É TH·ªä QUYNH"
                                        },
                                        {
                                            "doi": 5,
                                            "ho_ten": "L√É H·ªÆU KH·∫ÆC",
                                            "vo":
                                            [
                                                "L√É TH·ªä HAI",
                                                "NGUY·ªÑN TH·ªä S·∫ÆN"
                                            ],
                                            "con_cai":
                                            [
                                                {
                                                    "doi": 6,
                                                    "ho_ten": "L√É H·ªÆU NGHI"
                                                },
                                                {
                                                    "doi": 6,
                                                    "ho_ten": "L√É TH·ªä PH·∫¨N"
                                                },
                                                {
                                                    "doi": 6,
                                                    "ho_ten": "L√É H·ªÆU H·ªòI",
                                                    "vo": "D∆Ø∆†NG TH·ªä D√ÇU",
                                                    "con_cai":
                                                    [
                                                        {
                                                            "doi": 7,
                                                            "ho_ten": "L√É TH·ªä NHU·∫¨N"
                                                        },
                                                        {
                                                            "doi": 7,
                                                            "ho_ten": "L√É TH·ªä √ìN"
                                                        },
                                                        {
                                                            "doi": 7,
                                                            "ho_ten": "L√É H·ªÆU ƒê√îNG",
                                                            "vo":
                                                            [
                                                                "TR·ªäNH TH·ªä NH·ªöN",
                                                                "PH·∫†M TH·ªä KI·ªÜM"
                                                            ],
                                                            "con_cai":
                                                            [
                                                                {
                                                                    "doi": 8,
                                                                    "ho_ten": "L√É H·ªÆU THU",
                                                                    "vo": "V≈® TH·ªä M·ª∞U",
                                                                    "con_cai":
                                                                    [
                                                                        {
                                                                            "doi": 9,
                                                                            "ho_ten": "L√É H·ªÆU X·ª®NG",
                                                                            "vo": "L√É TH·ªä TH·∫¢O",
                                                                            "con_cai":
                                                                            [
                                                                                {
                                                                                    "doi": 10,
                                                                                    "ho_ten": "L√É H·ªÆU RY",
                                                                                    "vo":
                                                                                    [
                                                                                        "TR·ªäNH TH·ªä LU·∫¨T",
                                                                                        "V≈® TH·ªä NGUY·ªÜT"
                                                                                    ],
                                                                                    "con_cai":
                                                                                    [
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É TH·ªä CHUNG"
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É TH·ªä C√ÄI"
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É TH·ªä NGA"
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É TH·ªä NG·∫¶N"
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É TH·ªä V·∫¢I"
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É TH·ªä V√ìC"
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É H·ªÆU T√çN"
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É H·ªÆU TRUY·ªÄN",
                                                                                            "vo": "ƒêINH TH·ªä NHI√äN",
                                                                                            "con_cai":
                                                                                            [
                                                                                                {
                                                                                                    "doi": 12,
                                                                                                    "ho_ten": "L√É TH·ªä ANH"
                                                                                                },
                                                                                                {
                                                                                                    "doi": 12,
                                                                                                    "ho_ten": "L√É TH·ªä PH∆Ø∆†NG"
                                                                                                },
                                                                                                {
                                                                                                    "doi": 12,
                                                                                                    "ho_ten": "L√É TH·ªä HUY·ªÄN"
                                                                                                },
                                                                                                {
                                                                                                    "doi": 12,
                                                                                                    "ho_ten": "L√É TH·ªä MY"
                                                                                                }
                                                                                            ]
                                                                                        }
                                                                                    ]
                                                                                },
                                                                                {
                                                                                    "doi": 10,
                                                                                    "ho_ten": "L√É H·ªÆU T·∫ÆC",
                                                                                    "vo":
                                                                                    [
                                                                                        "D∆Ø∆†NG TH·ªä PH∆Ø∆†NG",
                                                                                        "TR·ªäNH TH·ªä LOAN"
                                                                                    ],
                                                                                    "con_cai":
                                                                                    [
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É TH·ªä TU·∫§T"
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É TH·ªä C√öC"
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É TH·ªä QU·∫æ"
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É TH·ªä HU·ªÜ"
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É H·ªÆU ƒê·ªò",
                                                                                            "ghi_chu": "m·∫•t s·ªõm"
                                                                                        }
                                                                                    ]
                                                                                },
                                                                                {
                                                                                    "doi": 10,
                                                                                    "ho_ten": "L√É H·ªÆU THO·∫†I",
                                                                                    "vo":
                                                                                    [
                                                                                        "L√É TH·ªä NH·ªä",
                                                                                        "L√É TH·ªä B√öT"
                                                                                    ],
                                                                                    "con_cai":
                                                                                    [
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É H·ªÆU C∆Ø·ªúNG",
                                                                                            "vo": "D∆Ø∆†NG TH·ªä NH√ÄI",
                                                                                            "con_cai":
                                                                                            [
                                                                                                {
                                                                                                    "doi": 12,
                                                                                                    "ho_ten": "L√É H·ªÆU QUANG"
                                                                                                },
                                                                                                {
                                                                                                    "doi": 12,
                                                                                                    "ho_ten": "L√É H·ªÆU D√ÇNG"
                                                                                                },
                                                                                                {
                                                                                                    "doi": 12,
                                                                                                    "ho_ten": "L√É TH·ªä DUNG"
                                                                                                }
                                                                                            ]
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É TH·ªä KI√äN"
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É H·ªÆU TH·ªäNH",
                                                                                            "vo": "D∆Ø∆†NG TH·ªä NGHI√äM",
                                                                                            "con_cai":
                                                                                            [
                                                                                                {
                                                                                                    "doi": 12,
                                                                                                    "ho_ten": "L√É H·ªÆU TH√ÄNH",
                                                                                                    "vo": "ƒêINH TH·ªä H∆Ø∆†NG",
                                                                                                    "con_cai":
                                                                                                    [
                                                                                                        {
                                                                                                            "doi": 13,
                                                                                                            "ho_ten": "L√É THANH T√ôNG"
                                                                                                        }
                                                                                                    ]
                                                                                                },
                                                                                                {
                                                                                                    "doi": 12,
                                                                                                    "ho_ten": "L√É TH·ªä TH·ª¶Y",
                                                                                                    "chong": "PH·∫†M QU·ªêC ƒê·∫†T",
                                                                                                    "con_cai":
                                                                                                    [
                                                                                                        {
                                                                                                            "doi": 13,
                                                                                                            "ho_ten": "PH·∫†M MAI ANH"
                                                                                                        },
                                                                                                        {
                                                                                                            "doi": 13,
                                                                                                            "ho_ten": "PH·∫†M KH√ÅNH D∆Ø∆†NG"
                                                                                                        }
                                                                                                    ]
                                                                                                }
                                                                                            ]
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É H·ªÆU VƒÇN",
                                                                                            "vo": "L√É TH·ªä B√çCH",
                                                                                            "con_cai":
                                                                                            [
                                                                                                {
                                                                                                    "doi": 12,
                                                                                                    "ho_ten": "L√É H·ªÆU BA"
                                                                                                },
                                                                                                {
                                                                                                    "doi": 12,
                                                                                                    "ho_ten": "L√É H·ªÆU C·∫¶N"
                                                                                                }
                                                                                            ]
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É H·ªÆU TH∆†",
                                                                                            "vo": "L√É TH·ªä NGA",
                                                                                            "con_cai":
                                                                                            [
                                                                                                {
                                                                                                    "doi": 12,
                                                                                                    "ho_ten": "L√É H·ªÆU TR∆Ø·ªúNG"
                                                                                                },
                                                                                                {
                                                                                                    "doi": 12,
                                                                                                    "ho_ten": "L√É TH·ªä TH∆Ø∆†NG"
                                                                                                }
                                                                                            ]
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É TH·ªä THI·ªÄU"
                                                                                        }
                                                                                    ]
                                                                                },
                                                                                {
                                                                                    "doi": 10,
                                                                                    "ho_ten": "L√É TH·ªä TH·ª§C"
                                                                                },
                                                                                {
                                                                                    "doi": 10,
                                                                                    "ho_ten": "L√É TH·ªä TR√Ä"
                                                                                },
                                                                                {
                                                                                    "doi": 10,
                                                                                    "ho_ten": "L√É H·ªÆU T·ª®",
                                                                                    "vo": "B√ôI TH·ªä NH∆Ø·ªúNG",
                                                                                    "con_cai":
                                                                                    [
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É TH·ªä H∆Ø∆†NG"
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É TH·ªä NGUY·ªÜT"
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É TH·ªä TUY·∫æT"
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É TH·ªä MAI"
                                                                                        },
                                                                                        {
                                                                                            "doi": 11,
                                                                                            "ho_ten": "L√É H·ªÆU MINH",
                                                                                            "vo": "HO√ÄNG TH·ªä HOA H·ªíNG",
                                                                                            "con_cai":
                                                                                            [
                                                                                                {
                                                                                                    "doi": 12,
                                                                                                    "ho_ten": "L√É TH·ªä MINH TH∆Ø"
                                                                                                }
                                                                                            ]
                                                                                        }
                                                                                    ]
                                                                                }
                                                                            ]
                                                                        },
                                                                        {
                                                                            "doi": 9,
                                                                            "ho_ten": "L√É TH·ªä PH·ª§NG"
                                                                        },
                                                                        {
                                                                            "doi": 9,
                                                                            "ho_ten": "L√É TH·ªä G√ÅI"
                                                                        }
                                                                    ]
                                                                },
                                                                {
                                                                    "doi": 8,
                                                                    "ho_ten": "L√É TH·ªä ƒê∆Ø·ªúNG"
                                                                },
                                                                {
                                                                    "doi": 8,
                                                                    "ho_ten": "L√É TH·ªä T√çU"
                                                                },
                                                                {
                                                                    "doi": 8,
                                                                    "ho_ten": "L√É H·ªÆU NHO",
                                                                    "vo":
                                                                    [
                                                                        "HO√ÄNG TH·ªä TH∆Ø",
                                                                        "D∆Ø∆†NG TH·ªä T√ÇM"
                                                                    ]
                                                                }
                                                            ]
                                                        },
                                                        {
                                                            "doi": 7,
                                                            "ho_ten": "L√É H·ªÆU TI·∫æT"
                                                        },
                                                        {
                                                            "doi": 7,
                                                            "ho_ten": "L√É H·ªÆU H·ªåT"
                                                        }
                                                    ]
                                                },
                                                {
                                                    "doi": 6,
                                                    "ho_ten": "L√É TH·ªä T·ª∞"
                                                },
                                                {
                                                    "doi": 6,
                                                    "ho_ten": "L√É H·ªÆU H·∫†NH",
                                                    "vo": "TR·ªäNH TH·ªä N·∫∫"
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        }
    ]
};

    // --- 2. QU·∫¢N L√ù D·ªÆ LI·ªÜU ---
    let genealogyData = JSON.parse(JSON.stringify(defaultData)); // Clone d·ªØ li·ªáu g·ªëc
    let flatMap = new Map(); // L∆∞u tham chi·∫øu ID -> Object ƒë·ªÉ ch·ªânh s·ª≠a nhanh
    let currentEditId = null;

    // H√†m ƒë√°nh ch·ªâ m·ª•c ID cho t·ª´ng node ƒë·ªÉ qu·∫£n l√Ω
    function indexData(members, parentId = 'root') {
        if (!members) return;
        members.forEach((member, index) => {
            // T·∫°o ID duy nh·∫•t n·∫øu ch∆∞a c√≥
            if (!member._id) {
                member._id = parentId + '_' + index + '_' + Math.random().toString(36).substr(2, 5);
            }
            flatMap.set(member._id, member);
            
            if (member.con_cai && member.con_cai.length > 0) {
                indexData(member.con_cai, member._id);
            }
        });
    }

    // Kh·ªüi t·∫°o
    function init() {
        flatMap.clear();
        indexData(genealogyData.cay_pha_he);
    }
    init();

    // --- 3. T√åM KI·∫æM V√Ä HI·ªÇN TH·ªä ---
    function formatSpouseData(spouseData) {
        if (!spouseData) return null;
        if (Array.isArray(spouseData)) return spouseData.join(", ");
        return spouseData;
    }

    function formatChildren(childrenArray) {
        if (!childrenArray || childrenArray.length === 0) return null;
        return childrenArray.map(child => child.ho_ten).join(", ");
    }

    function searchMember() {
        const query = document.getElementById('searchInput').value.toLowerCase().trim();
        const resultsArea = document.getElementById('resultsArea');
        
        if (!query) {
            resultsArea.innerHTML = '<p class="no-result">Vui l√≤ng nh·∫≠p t√™n ƒë·ªÉ t√¨m ki·∫øm.</p>';
            return;
        }

        const results = [];
        flatMap.forEach(member => {
            if (member.ho_ten.toLowerCase().includes(query)) {
                results.push(member);
            }
        });

        if (results.length === 0) {
            resultsArea.innerHTML = '<p class="no-result">Kh√¥ng t√¨m th·∫•y th√†nh vi√™n n√†o c√≥ t√™n "' + query + '".</p>';
        } else {
            let html = '<ul class="result-list">';
            results.forEach(mem => {
                let spouseHtml = '';
                if (mem.vo) spouseHtml = `<div class="member-info"><span class="label">V·ª£:</span> ${formatSpouseData(mem.vo)}</div>`;
                else if (mem.chong) spouseHtml = `<div class="member-info"><span class="label">Ch·ªìng:</span> ${formatSpouseData(mem.chong)}</div>`;
                else spouseHtml = `<div class="member-info"><span class="label">V·ª£/Ch·ªìng:</span> <span style="color:#999; font-style:italic">Ch∆∞a c·∫≠p nh·∫≠t</span></div>`;

                const childrenStr = formatChildren(mem.con_cai);
                const childrenHtml = childrenStr 
                    ? `<div class="children-list"><span class="children-label">C√°c con:</span>${childrenStr}</div>` 
                    : '';

                html += `
                    <li class="member-card">
                        <div class="member-header">
                            <span class="member-name">${mem.ho_ten}</span>
                            <span class="member-gen">ƒê·ªùi th·ª© ${mem.doi}</span>
                        </div>
                        ${mem.ten_khac ? `<div class="member-info"><span class="label">T√™n kh√°c:</span> ${mem.ten_khac}</div>` : ''}
                        ${mem.chuc_vu ? `<div class="member-info"><span class="label">Ch·ª©c v·ª•:</span> ${mem.chuc_vu}</div>` : ''}
                        ${spouseHtml}
                        ${mem.ghi_chu ? `<div class="member-info"><span class="label">Ghi ch√∫:</span> ${mem.ghi_chu}</div>` : ''}
                        ${childrenHtml}

                        <div class="actions">
                            <button class="btn-action btn-add-spouse" onclick="openSpouseModal('${mem._id}')">+ Th√™m V·ª£/Ch·ªìng</button>
                            <button class="btn-action btn-add-child" onclick="openChildModal('${mem._id}')">+ Th√™m Con</button>
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
            resultsArea.innerHTML = html;
        }
    }

    // H·ªó tr·ª£ ·∫•n Enter ƒë·ªÉ t√¨m
    document.getElementById("searchInput").addEventListener("keyup", function(event) {
        if (event.key === "Enter") searchMember();
    });

    // --- 4. CH·ª®C NƒÇNG CH·ªàNH S·ª¨A (Th√™m V·ª£/Ch·ªìng/Con) ---
    function openSpouseModal(id) {
        currentEditId = id;
        document.getElementById('spouseName').value = '';
        document.getElementById('spouseModal').style.display = 'block';
    }

    function openChildModal(id) {
        currentEditId = id;
        document.getElementById('childName').value = '';
        document.getElementById('childNote').value = '';
        document.getElementById('childModal').style.display = 'block';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        currentEditId = null;
    }

    function confirmAddSpouse() {
        if (!currentEditId) return;
        const name = document.getElementById('spouseName').value.trim();
        const role = document.getElementById('spouseRole').value; // 'vo' ho·∫∑c 'chong'

        if (!name) { alert("Vui l√≤ng nh·∫≠p t√™n!"); return; }

        const member = flatMap.get(currentEditId);
        if (member) {
            // Logic th√™m v·ª£/ch·ªìng: N·∫øu ƒë√£ c√≥ th√¨ chuy·ªÉn th√†nh m·∫£ng ho·∫∑c th√™m v√†o m·∫£ng
            if (!member[role]) {
                member[role] = name;
            } else {
                if (Array.isArray(member[role])) {
                    member[role].push(name);
                } else {
                    member[role] = [member[role], name];
                }
            }
            alert("ƒê√£ th√™m th√†nh c√¥ng!");
            closeModal('spouseModal');
            searchMember(); // T·∫£i l·∫°i k·∫øt qu·∫£ ƒë·ªÉ th·∫•y thay ƒë·ªïi
        }
    }

    function confirmAddChild() {
        if (!currentEditId) return;
        const name = document.getElementById('childName').value.trim();
        const gender = document.getElementById('childGender').value;
        const note = document.getElementById('childNote').value.trim();

        if (!name) { alert("Vui l√≤ng nh·∫≠p t√™n con!"); return; }

        const parent = flatMap.get(currentEditId);
        if (parent) {
            if (!parent.con_cai) parent.con_cai = [];
            
            const newChild = {
                "doi": parent.doi + 1,
                "ho_ten": name,
                "gioi_tinh": gender
            };
            if (note) newChild.ghi_chu = note;

            parent.con_cai.push(newChild);

            // Re-index ƒë·ªÉ con m·ªõi c√≥ ID
            init(); 
            
            alert("ƒê√£ th√™m con th√†nh c√¥ng!");
            closeModal('childModal');
            searchMember();
        }
    }

    // --- 5. T·∫¢I V√Ä L∆ØU FILE JSON ---
    async function loadDataFromUrl() {
        const url = document.getElementById('jsonUrl').value.trim();
        if (!url) {
            alert("ƒêang s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫∑c ƒë·ªãnh.");
            genealogyData = JSON.parse(JSON.stringify(defaultData));
            init();
            return;
        }

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i file.");
            const jsonData = await response.json();
            genealogyData = jsonData;
            init();
            alert("ƒê√£ t·∫£i d·ªØ li·ªáu m·ªõi th√†nh c√¥ng!");
            document.getElementById('resultsArea').innerHTML = '<p class="no-result">D·ªØ li·ªáu ƒë√£ c·∫≠p nh·∫≠t. H√£y t√¨m ki·∫øm l·∫°i.</p>';
        } catch (error) {
            alert("L·ªói: " + error.message + "\nH√£y ƒë·∫£m b·∫£o link l√† Raw JSON (v√≠ d·ª• t·ª´ GitHub Raw).");
        }
    }

    function downloadJSON() {
        // X√≥a c√°c tr∆∞·ªùng _id t·∫°m th·ªùi tr∆∞·ªõc khi l∆∞u ƒë·ªÉ file s·∫°ch ƒë·∫πp
        const cleanData = JSON.parse(JSON.stringify(genealogyData));
        function removeTempIds(list) {
            if(!list) return;
            list.forEach(item => {
                delete item._id;
                if (item.con_cai) removeTempIds(item.con_cai);
            });
        }
        removeTempIds(cleanData.cay_pha_he);

        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cleanData, null, 4));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "GiaPha_LaHuu_CapNhat.json");
        document.body.appendChild(downloadAnchorNode); // Firefox required
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    // ƒê√≥ng modal khi click ra ngo√†i
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }

    var modal = document.getElementById("historyModal");
    function openModal() { modal.style.display = "block"; }
    function closeModal() { modal.style.display = "none"; }
    window.onclick = function(event) {
        if (event.target == modal) { modal.style.display = "none"; }
    }

</script>

</body>
</html>